<!DOCTYPE html>
<html>

<body>





<div id="id01" class="modal" style="display:block">
  
  <form class="modal-content animate">
    <div class="imgcontainer">
      <span onclick="window.close()" class="close" id='close' title="Close Modal">&times;</span>
      <img src="./images/Hema.png" alt="Avatar" class="avatar">
    </div>

    <div class="container">
		<div id="containerBody">
		  <label for="uname"><b>Emp ID</b></label>
		  <input type="text" placeholder="Emp ID" id = "uname" name="uname" required>
		       					
		  <button type="button" onClick="validateLogin()">Login</button>
	  </div>
      <label>
        <span id="status"></span>
      </label>
    </div>
    <div class="container" style="background-color:#f1f1f1">      
      <span class="psw">Forgot <a href="#">password?</a></span>
    </div>
  </form>
</div>



     

<script>
var webAuth;
var session = window.location.href.split('=')[1];
console.log(session);
function validateLogin() {
	var xmlhttp = new XMLHttpRequest();
	xmlhttp.onreadystatechange = function() {
		if (this.readyState == 4){
			if(this.status == 200) {	
			var accDet = JSON.parse(this.responseText).accDet;	
			console.log(accDet);
			webAuth = new auth0.WebAuth({
				domain:       accDet.domainName,
				clientID:     accDet.clientID,
				responseType: 'token',
				redirectUri: accDet.redirectUri+'?empId='+document.getElementById("uname").value,
				responseType: 'token id_token'
			  }); 
			  var respText = '<label for="psw"><b>Enter OTP</b></label><input type="password" placeholder="Password" id="otp" name="otp" required><button type="button" onClick="validateOtp('+accDet.phoneNumber+')">Login</button>';
			// Send a verification code using SMS			
			  webAuth.passwordlessStart({
				  connection: 'sms',
				  send: 'code',
				  phoneNumber: accDet.phoneNumber
				}, function (err,res) {
				  if(err){
					console.log(err);
				  }else{
					document.getElementById("containerBody").innerHTML = respText;
				  }					  					  
				}
			  );
			}else if(this.status == 400){
				console.log('hari');
				alert('test');
				document.getElementById("status").innerHTML = "invalid username/password";
			}
		}
	};
	xmlhttp.open("POST", "https://logintests.herokuapp.com/validateUser");
	xmlhttp.setRequestHeader("Content-Type", "application/json");
	xmlhttp.send(JSON.stringify({username:document.getElementById("uname").value,sess:session}));	
}

function validateOtp(phone) {		
	console.log(phone);
	webAuth.passwordlessLogin({
      connection: 'sms',
      phoneNumber: '+'+phone,
      verificationCode: document.getElementById('otp').value
    }, function (err,res) {
		if(err){
			document.getElementById('status').innerHTML = 'Invalid OTP, Please enter valid one';
			console.log(err);
		}else{						
			document.getElementById("close").click();
		}
    }
  );	
}

</script>

</body>
</html>
